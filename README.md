# Video_generator

## 项目概述
本项目是一个基于 Python 的自动化视频生成工具，能够根据输入的 Excel 文件（包含文本、时长和画面描述）以及图像文件，生成带有语音、字幕和动态视觉效果的视频。项目结合了文本转语音（TTS）、图像分割、自然语言处理（NLP）以及视频处理技术，支持对图像进行聚焦、平移、缩放和亮度调整等操作，同时生成匹配的音频和字幕。

## 功能特性
- **文本转语音（TTS）**：将输入的文本转换为语音，支持调整语速和音调，并生成固定时长的音频。
- **图像分割与定位**：使用中文 CLIP 模型和 SAM（Segment Anything Model）对图像进行分割，并根据文本描述定位目标区域。
- **视频生成**：根据画面描述生成动态视频效果，包括聚焦、拉远、平移和亮度调整。
- **字幕支持**：自动为视频添加字幕，字幕内容与音频同步。
- **日志记录**：详细记录处理过程，便于调试和错误排查。

## 项目结构
以下是项目的主要文件及其功能：
- **speech_service.py**：实现文本转语音功能，使用 pyttsx3 生成音频，并支持音频合并和音调调整。
- **keyword_extractor.py**：从画面描述中提取操作信息（如聚焦、平移、亮度调整等）以及速度和位置信息。
- **position_find.py**：利用中文 CLIP 模型和 SAM 模型对图像进行分割，并根据文本描述定位目标区域的中心坐标。
- **videomaker.py**：根据操作指令生成视频，支持动态效果（如缩放、平移）和字幕添加。
- **main.py**：主程序，协调各模块，读取 Excel 输入，调用语音、定位和视频生成功能。

## 安装与依赖
请确保安装了以下依赖项，具体版本要求见 `requirements.txt`。

### 安装步骤
1. 克隆或下载项目代码到本地：
   ```bash
   git clone <仓库地址>
   cd <项目文件夹>
   ```
2. 创建并激活虚拟环境（推荐）：
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```
3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
4. 准备模型文件：
   - 将SAM 模型权重（`sam_vit_h_4b8939.pth`）放置在项目根目录。
   - 将中文 CLIP 模型 (`chinese-clip-vit-large-patch14-336px`) 放置在项目根目录。
5. 准备输入文件：
   - 提供一个 Excel 文件，包含以下列：`文本`（用于语音）、`时长`（秒）、`画面内容`（描述视频效果）、`备注`（可选补充描述）。
   - 提供一张图像文件（例如 `image.jpg`）。
6. 运行程序：
   ```bash
   python main.py <Excel文件路径> <图像文件路径>
   ```

## 使用示例
假设你有一个 Excel 文件 `input.xlsx` 和图像文件 `image.jpg`，运行以下命令：
```bash
python main.py input.xlsx image.jpg
```
程序将生成一个视频文件 `output.mp4`，包含语音、字幕和基于画面描述的动态效果。

### 示例 Excel 文件格式
| 文本                     | 时长 | 画面内容                              | 备注 |
|--------------------------|------|---------------------------------------|------|
| 你好，这是一个测试文本   | 3    | 聚焦于海面平静的部分                  |      |
| 这是第二个测试文本       | 5    | 缓缓移动到海浪轻柔拍打礁石的画面     |      |
| 结尾充满希望             | 4    | 画面亮度提高，展现整体壮阔            |      |

### 输出
- 音频文件：`audios/output.wav`（中间文件，最终会被清理）。
- 视频文件：`output.mp4`，包含语音、字幕和动态效果。

## 依赖项
详见 `requirements.txt`。

## 注意事项
- **模型文件**：确保 SAM 模型权重文件（`sam_vit_h_4b8939.pth`）和 中文CLIP模型文件夹（`chinese-clip-vit-large-patch14-336px`）目根目录。
- **字体文件**：字幕生成需要 `font.ttf` 文件，确保其存在于项目根目录(已放置在根目录)，或修改 `videomaker.py` 中的字体路径。
- **硬件要求**：建议使用支持 CUDA 的 GPU 以加速 CLIP 和 SAM 模型的处理。若无 GPU，程序将自动使用 CPU，但处理速度较慢。
- **输入格式**：Excel 文件需严格遵循指定格式，画面描述需使用清晰的中文描述以确保关键词提取准确，使用方位词，如中间，左，右等定位会更加准确。
- **清理临时文件**：程序会自动清理中间生成的音频和视频文件，但如遇异常中断，可能需要手动删除 `audios/` 目录下的临时文件或 `temp.mp4` 等。

## 局限性
- 字幕字体和样式固定，可通过修改 `videomaker.py` 自定义。
- SAM 和 CLIP 模型对复杂场景的分割和定位可能存在偏差，需优化输入描述以提高准确性。
